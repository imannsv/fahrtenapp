<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fahrten Abrechnung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <!-- Framework7 CSS -->
  <link rel="stylesheet" href="https://unpkg.com/framework7/framework7-bundle.min.css">
  <style>
    body {
      background: linear-gradient(180deg, #f5f7fb, #e4ecf7);
    }
    .navbar-inner {
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: #fff;
    }
    .navbar .title {
      color: #fff;
      font-weight: 600;
    }
    .page-content {
      padding-top: 0;
    }
    .app-header {
      padding: 16px 16px 8px;
      color: #111827;
    }
    .app-header-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .app-header-subtitle {
      font-size: 13px;
      color: #6b7280;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      border: none;
    }
    .block-title {
      margin-top: 16px;
      margin-bottom: 4px;
      padding-left: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .button.button-fill.color-primary {
      border-radius: 999px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .summary-label {
      font-weight: 500;
      color: #4b5563;
    }
    .summary-value {
      text-align: right;
      font-weight: 600;
      color: #111827;
    }
    .summary-value-strong {
      font-size: 16px;
    }
    .summary-value-green {
      color: #059669;
    }
    .summary-value-red {
      color: #b91c1c;
    }
    .money {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .pill-online {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .pill-bar {
      background: #fef3c7;
      color: #92400e;
    }
    .pill-distance {
      background: #dcfce7;
      color: #166534;
      margin-left: 4px;
    }
    .fahrten-card {
      margin-top: 8px;
    }
    .toolbar-inner {
      font-size: 12px;
    }
    .toolbar-inner span {
      opacity: 0.8;
    }
    .no-fahrten-placeholder {
      padding: 8px 0;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
    }
    .actions-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    .actions-row a {
      flex: 1;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- App root -->
  <div id="app">
    <!-- Hauptansicht -->
    <div class="view view-main">
      <div class="page">
        <!-- Navbar -->
        <div class="navbar">
          <div class="navbar-inner">
            <div class="title">Fahrten Abrechnung</div>
          </div>
        </div>

        <div class="page-content">
          <!-- Header -->
          <div class="app-header">
            <div class="app-header-title">Fahrten & Stunden</div>
            <div class="app-header-subtitle">
              Erfasse deine Fahrten und sieh direkt, was dir noch ausgezahlt werden muss.
            </div>
          </div>

          <!-- Abschnitt: Neue Fahrt -->
          <div class="block-title">Neue Fahrt</div>
          <div class="card">
            <div class="card-content card-content-padding">
              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Adresse</div>
                      <div class="item-input-wrap">
                        <input type="text" id="adresse" placeholder="z.B. Musterstraße 1, Hannover">
                      </div>
                    </div>
                  </li>

                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Zahlungsart</div>
                      <div class="item-input-wrap">
                        <select id="zahlungsart">
                          <option value="online">Online</option>
                          <option value="bar">Bar</option>
                        </select>
                      </div>
                    </div>
                  </li>

                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Bargeldbetrag (€)</div>
                      <div class="item-input-wrap">
                        <input type="number" id="bargeld" step="0.01" min="0" placeholder="nur bei Barzahlung" disabled>
                      </div>
                    </div>
                  </li>

                  <li>
                    <label class="item-checkbox item-content">
                      <input type="checkbox" id="ueber5km">
                      <i class="icon icon-checkbox"></i>
                      <div class="item-inner">
                        <div class="item-title">&gt; 5 km von der Arbeit entfernt (+0,50&nbsp;€)</div>
                      </div>
                    </label>
                  </li>
                </ul>
              </div>

              <div class="block" style="margin-top: 8px; margin-bottom: 0;">
                <a class="button button-fill color-primary" id="addFahrtBtn">Fahrt hinzufügen</a>
              </div>
            </div>
          </div>

          <!-- Abschnitt: Fahrtenliste -->
          <div class="block-title">Erfasste Fahrten</div>
          <div class="card fahrten-card">
            <div class="card-content">
              <div class="list media-list" id="fahrtenListe">
                <!-- Einträge werden per JS eingefügt -->
              </div>
            </div>
          </div>

          <!-- Abschnitt: Abrechnung -->
          <div class="block-title">Abrechnung</div>
          <div class="card">
            <div class="card-content card-content-padding">

              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Stunden gearbeitet</div>
                      <div class="item-input-wrap">
                        <input type="number" id="stunden" step="0.25" min="0" value="0">
                      </div>
                    </div>
                  </li>

                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Stundenlohn (€)</div>
                      <div class="item-input-wrap">
                        <input type="number" id="stundenlohn" step="0.01" min="0" value="7.5">
                      </div>
                    </div>
                  </li>
                </ul>
              </div>

              <div class="block" style="margin-top: 8px;">
                <div class="summary-row">
                  <div class="summary-label">Anzahl Fahrten</div>
                  <div class="summary-value" id="anzahlFahrten">0</div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Fahrten &gt; 5 km</div>
                  <div class="summary-value" id="anzahlÜber5">0</div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Summe Bargeld</div>
                  <div class="summary-value money" id="summeBargeld">0,00&nbsp;€</div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Lohn Stunden</div>
                  <div class="summary-value money" id="lohnStunden">0,00&nbsp;€</div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Vergütung Fahrten</div>
                  <div class="summary-value money" id="lohnFahrten">0,00&nbsp;€</div>
                </div>
                <hr>
                <div class="summary-row">
                  <div class="summary-label">Gesamt (Stunden + Fahrten)</div>
                  <div class="summary-value money summary-value-strong" id="gesamtBrutto">0,00&nbsp;€</div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Noch auszuzahlen (− Bargeld)</div>
                  <div class="summary-value money summary-value-strong summary-value-green" id="nettoAuszahlung">0,00&nbsp;€</div>
                </div>
              </div>

              <div class="block actions-row">
                <a href="#" id="resetBtn" style="font-size:12px; color:#ef4444;">Alles zurücksetzen</a>
                <a href="#" id="exportPdfBtn" style="font-size:12px; color:#2563eb;">Als PDF exportieren</a>
              </div>

            </div>
          </div>

        </div> <!-- page-content -->

        <!-- Toolbar unten -->
        <div class="toolbar toolbar-bottom">
          <div class="toolbar-inner">
            <span>Grundvergütung: 1,50 € pro Fahrt · &gt;5 km: +0,50 €</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Framework7 JS -->
  <script src="https://unpkg.com/framework7/framework7-bundle.min.js"></script>
  <!-- jsPDF (für PDF-Export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Framework7 App initialisieren
    var app = new Framework7({
      root: '#app',
      theme: 'ios'
    });

    const { jsPDF } = window.jspdf;

    // Konstante Werte
    const BASIS_PRO_FAhrt = 1.5;
    const BONUS_UEBER_5KM = 0.5;
    const STORAGE_KEY = 'fahrtenAppData_v1';

    // State
    let fahrten = [];

    // Elemente
    const adresseInput        = document.getElementById('adresse');
    const zahlungsartSelect   = document.getElementById('zahlungsart');
    const bargeldInput        = document.getElementById('bargeld');
    const ueber5kmCheckbox    = document.getElementById('ueber5km');
    const addFahrtBtn         = document.getElementById('addFahrtBtn');
    const fahrtenListe        = document.getElementById('fahrtenListe');

    const stundenInput        = document.getElementById('stunden');
    const stundenlohnInput    = document.getElementById('stundenlohn');

    const anzahlFahrtenSpan   = document.getElementById('anzahlFahrten');
    const anzahlÜber5Span     = document.getElementById('anzahlÜber5');
    const summeBargeldSpan    = document.getElementById('summeBargeld');
    const lohnStundenSpan     = document.getElementById('lohnStunden');
    const lohnFahrtenSpan     = document.getElementById('lohnFahrten');
    const gesamtBruttoSpan    = document.getElementById('gesamtBrutto');
    const nettoAuszahlungSpan = document.getElementById('nettoAuszahlung');
    const resetBtn            = document.getElementById('resetBtn');
    const exportPdfBtn        = document.getElementById('exportPdfBtn');

    function parseEuro(value) {
      if (value === null || value === undefined) return 0;
      if (value === '') return 0;
      return parseFloat(String(value).replace(',', '.')) || 0;
    }

    function formatEuro(num) {
      return num.toFixed(2).replace('.', ',') + ' €';
    }

    // LocalStorage laden
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data.fahrten)) {
          fahrten = data.fahrten;
        }
        if (typeof data.stunden === 'number') {
          stundenInput.value = data.stunden;
        }
        if (typeof data.stundenlohn === 'number') {
          stundenlohnInput.value = data.stundenlohn;
        }
      } catch (e) {
        console.error('Fehler beim Laden aus LocalStorage', e);
      }
    }

    // LocalStorage speichern
    function saveState() {
      const data = {
        fahrten,
        stunden: parseEuro(stundenInput.value),
        stundenlohn: parseEuro(stundenlohnInput.value)
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Fehler beim Speichern in LocalStorage', e);
      }
    }

    zahlungsartSelect.addEventListener('change', () => {
      if (zahlungsartSelect.value === 'bar') {
        bargeldInput.disabled = false;
      } else {
        bargeldInput.disabled = true;
        bargeldInput.value = '';
      }
    });

    addFahrtBtn.addEventListener('click', () => {
      const adresse   = adresseInput.value.trim();
      const zahlungsart = zahlungsartSelect.value;
      const ueber5km  = ueber5kmCheckbox.checked;

      if (!adresse) {
        app.dialog.alert('Bitte eine Adresse eingeben.');
        return;
      }

      let bargeld = 0;
      if (zahlungsart === 'bar') {
        bargeld = parseEuro(bargeldInput.value);
      }

      const vergütung = BASIS_PRO_FAhrt + (ueber5km ? BONUS_UEBER_5KM : 0);

      fahrten.push({
        adresse,
        zahlungsart,
        bargeld,
        ueber5km,
        vergütung
      });

      // Eingaben zurücksetzen
      adresseInput.value = '';
      ueber5kmCheckbox.checked = false;
      if (zahlungsart === 'bar') {
        bargeldInput.value = '';
      }

      renderFahrten();
      berechneZusammenfassung();
      saveState();
    });

    [stundenInput, stundenlohnInput].forEach(el => {
      el.addEventListener('input', () => {
        berechneZusammenfassung();
        saveState();
      });
    });

    resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      app.dialog.confirm('Wirklich alle Daten löschen?', 'Zurücksetzen', () => {
        fahrten = [];
        stundenInput.value = '0';
        stundenlohnInput.value = '7.5';
        renderFahrten();
        berechneZusammenfassung();
        saveState();
      });
    });

    exportPdfBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (fahrten.length === 0) {
        app.dialog.alert('Es sind noch keine Fahrten erfasst.', 'PDF Export');
        return;
      }
      exportToPdf();
    });

    function renderFahrten() {
      if (fahrten.length === 0) {
        fahrtenListe.innerHTML = '<div class="no-fahrten-placeholder">Noch keine Fahrten erfasst.</div>';
        return;
      }

      let html = '<ul>';
      fahrten.forEach((f, index) => {
        const pillZahlungClass = f.zahlungsart === 'bar' ? 'pill pill-bar' : 'pill pill-online';
        const pillZahlungText = f.zahlungsart === 'bar' ? 'Bar' : 'Online';

        html += `
          <li>
            <div class="item-content">
              <div class="item-inner">
                <div class="item-title-row">
                  <div class="item-title">${index + 1}. ${f.adresse}</div>
                  <div class="item-after money">${f.vergütung.toFixed(2)} €</div>
                </div>
                <div class="item-subtitle">
                  <span class="${pillZahlungClass}">${pillZahlungText}</span>
                  ${f.ueber5km ? '<span class="pill pill-distance">&gt;5 km</span>' : ''}
                  ${f.bargeld > 0 ? ' · Bargeld: ' + f.bargeld.toFixed(2) + ' €' : ''}
                </div>
              </div>
            </div>
          </li>
        `;
      });
      html += '</ul>';
      fahrtenListe.innerHTML = html;
    }

    function berechneZusammenfassung() {
      const anzahl = fahrten.length;
      const anzahlÜber5 = fahrten.filter(f => f.ueber5km).length;
      const summeBargeld = fahrten.reduce((sum, f) => sum + f.bargeld, 0);
      const summeFahrtenVergütung = fahrten.reduce((sum, f) => sum + f.vergütung, 0);

      const stunden    = parseEuro(stundenInput.value);
      const stundenlohn = parseEuro(stundenlohnInput.value);

      const lohnStunden = stunden * stundenlohn;
      const gesamtBrutto = lohnStunden + summeFahrtenVergütung;
      const nettoAuszahlung = gesamtBrutto - summeBargeld;

      anzahlFahrtenSpan.textContent    = anzahl;
      anzahlÜber5Span.textContent      = anzahlÜber5;
      summeBargeldSpan.innerHTML       = formatEuro(summeBargeld);
      lohnStundenSpan.innerHTML        = formatEuro(lohnStunden);
      lohnFahrtenSpan.innerHTML        = formatEuro(summeFahrtenVergütung);
      gesamtBruttoSpan.innerHTML       = formatEuro(gesamtBrutto);

      nettoAuszahlungSpan.innerHTML    = formatEuro(nettoAuszahlung);
      nettoAuszahlungSpan.classList.remove('summary-value-green', 'summary-value-red');
      if (nettoAuszahlung >= 0) {
        nettoAuszahlungSpan.classList.add('summary-value-green');
      } else {
        nettoAuszahlungSpan.classList.add('summary-value-red');
      }
    }

    // PDF-Export
    function exportToPdf() {
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const marginLeft = 15;
      let y = 15;

      const today = new Date();
      const dateStr = today.toLocaleDateString('de-DE');

      doc.setFontSize(16);
      doc.text('Fahrten-Abrechnung', marginLeft, y);
      y += 7;

      doc.setFontSize(11);
      doc.text('Datum: ' + dateStr, marginLeft, y);
      y += 8;

      // Tabelle Kopf
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('Nr', marginLeft, y);
      doc.text('Adresse', marginLeft + 10, y);
      doc.text('Zahlung', marginLeft + 90, y);
      doc.text('Bargeld', marginLeft + 120, y);
      doc.text('>5 km', marginLeft + 145, y);
      doc.text('Vergütung', marginLeft + 165, y);
      y += 4;

      doc.setLineWidth(0.1);
      doc.line(marginLeft, y, 200 - marginLeft, y);
      y += 4;

      doc.setFont('helvetica', 'normal');

      fahrten.forEach((f, index) => {
        if (y > 260) { // neue Seite, wenn es unten eng wird
          doc.addPage();
          y = 15;
        }
        const nr = String(index + 1);
        const adresse = f.adresse;
        const zahlung = f.zahlungsart === 'bar' ? 'Bar' : 'Online';
        const bargeld = f.bargeld > 0 ? f.bargeld.toFixed(2) + ' €' : '-';
        const dist = f.ueber5km ? 'Ja' : 'Nein';
        const verg = f.vergütung.toFixed(2) + ' €';

        doc.text(nr, marginLeft, y);
        // Adresse evtl. kürzen
        const maxAdresseLen = 40;
        let adrText = adresse;
        if (adresse.length > maxAdresseLen) {
          adrText = adresse.substring(0, maxAdresseLen - 3) + '...';
        }
        doc.text(adrText, marginLeft + 10, y);
        doc.text(zahlung, marginLeft + 90, y);
        doc.text(bargeld, marginLeft + 120, y);
        doc.text(dist, marginLeft + 145, y);
        doc.text(verg, marginLeft + 165, y);
        y += 5;
      });

      // Zusammenfassung
      y += 6;
      if (y > 260) {
        doc.addPage();
        y = 15;
      }

      const anzahl = fahrten.length;
      const anzahlÜber5 = fahrten.filter(f => f.ueber5km).length;
      const summeBargeld = fahrten.reduce((sum, f) => sum + f.bargeld, 0);
      const summeFahrtenVergütung = fahrten.reduce((sum, f) => sum + f.vergütung, 0);
      const stunden = parseEuro(stundenInput.value);
      const stundenlohn = parseEuro(stundenlohnInput.value);
      const lohnStunden = stunden * stundenlohn;
      const gesamtBrutto = lohnStunden + summeFahrtenVergütung;
      const nettoAuszahlung = gesamtBrutto - summeBargeld;

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('Zusammenfassung', marginLeft, y);
      y += 6;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const lines = [
        'Anzahl Fahrten: ' + anzahl,
        'Fahrten > 5 km: ' + anzahlÜber5,
        'Stunden gearbeitet: ' + stunden + ' h',
        'Stundenlohn: ' + stundenlohn.toFixed(2) + ' €',
        'Lohn Stunden: ' + lohnStunden.toFixed(2) + ' €',
        'Vergütung Fahrten: ' + summeFahrtenVergütung.toFixed(2) + ' €',
        'Summe Bargeld: ' + summeBargeld.toFixed(2) + ' €',
        'Gesamt (Stunden + Fahrten): ' + gesamtBrutto.toFixed(2) + ' €',
        'Noch auszuzahlen (− Bargeld): ' + nettoAuszahlung.toFixed(2) + ' €'
      ];

      lines.forEach(line => {
        doc.text(line, marginLeft, y);
        y += 5;
      });

      const fileName = 'fahrten_' + today.toISOString().slice(0,10) + '.pdf';
      doc.save(fileName);
    }

    // Initial: State laden, dann UI bauen
    loadState();
    renderFahrten();
    berechneZusammenfassung();
  </script>
</body>
</html>
