<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrten & Stunden</title>

    <style>
        /* --------------------------------------------------------
           GLOBAL STYLES
        -------------------------------------------------------- */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background: #f1f5f9;
            color: #0f172a;
        }

        .dark body {
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 14px;
        }

        /* --------------------------------------------------------
           HEADER
        -------------------------------------------------------- */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .title {
            font-size: 22px;
            font-weight: 700;
        }

        .settings-wrapper {
            position: relative;
            display: inline-flex;
        }

        .settings-btn {
            border: none;
            background: rgba(15,23,42,0.05);
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 18px;
            cursor: pointer;
        }

        .dark .settings-btn {
            background: rgba(255,255,255,0.08);
        }

        .update-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: #ef4444;
            border: 2px solid #ffffff;
        }

        .dark .update-badge {
            border-color: #0f172a;
        }

        /* --------------------------------------------------------
           SETTINGS POPUP (iOS-Like)
        -------------------------------------------------------- */
        .settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(3px);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .settings-card {
            position: relative;
            background: #ffffff;
            padding: 20px;
            border-radius: 14px;
            width: 84%;
            max-width: 340px;
            color: #0f172a;
            animation: settingsSlideUp 0.24s cubic-bezier(0.22, 0.61, 0.36, 1);
        }

        .dark .settings-card {
            background: #1e293b;
            color: #e2e8f0;
        }

        @keyframes settingsSlideUp {
            from {
                transform: translateY(40px) scale(0.98);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .settings-close-x {
            position: absolute;
            right: 8px;
            top: 8px;
            background: transparent;
            color: inherit;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .settings-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .settings-toggle {
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            font-size: 15px;
            cursor: pointer;
        }

        .dark .settings-toggle {
            background: #0f172a;
            border-color: #475569;
        }

        .close-settings {
            width: 100%;
            padding: 8px 0;
            margin-top: 8px;
            border-radius: 8px;
            border: none;
            background: #2563eb;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* --------------------------------------------------------
           FORM
        -------------------------------------------------------- */
        label {
            display: block;
            margin-bottom: 10px;
        }

            label span {
                font-size: 14px;
                opacity: 0.8;
            }

        input, select {
            margin-top: 3px;
            width: 100%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 15px;
            background: #ffffff;
            color: #0f172a;
        }

        .dark input, .dark select {
            background: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }

            /* Datalist dropdown fix for darkmode */
            .dark input::-webkit-calendar-picker-indicator {
                filter: invert(75%);
            }

        /* --------------------------------------------------------
           BUTTON PRIMARY
        -------------------------------------------------------- */
        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            margin-top: 6px;
        }

        /* --------------------------------------------------------
           FARTENLISTE
        -------------------------------------------------------- */
        #fahrtenListe {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .fahrt-item {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .dark .fahrt-item {
            background: #1e293b;
        }

        .fahrt-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .fahrt-adresse {
            font-size: 15px;
            font-weight: 600;
            color: inherit;
        }

        .dark .fahrt-adresse {
            color: #f1f5f9;
        }

        .fahrt-verg {
            font-size: 15px;
            font-weight: 600;
            color: #0f172a;
        }

        .dark .fahrt-verg {
            color: #e2e8f0; /* hier jetzt heller */
        }

        .fahrt-meta {
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .fahrt-meta-left span {
            margin-right: 6px;
            opacity: 0.9;
        }

        .fahrt-meta-right {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            background: #e2e8f0;
            cursor: pointer;
        }

        .dark .btn-small {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-small.delete {
            background: #fca5a5;
        }

        .dark .btn-small.delete {
            background: #b91c1c;
        }

        /* --------------------------------------------------------
           PILL STYLES
        -------------------------------------------------------- */
        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .pill-bar {
            background: #fde68a;
            color: #92400e;
        }

        .pill-online {
            background: #bfdbfe;
            color: #1d4ed8;
        }

        .pill-distance {
            background: #d1fae5;
            color: #065f46;
        }

        /* --------------------------------------------------------
           SUMMARY
        -------------------------------------------------------- */
        .summary-box {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-top: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .dark .summary-box {
            background: #1e293b;
        }

        .summary-line {
            margin-bottom: 4px;
            font-size: 14px;
        }

        .summary-value {
            float: right;
            font-weight: 600;
        }

        .summary-green {
            color: #10b981 !important;
        }

        .summary-red {
            color: #ef4444 !important;
        }

        /* --------------------------------------------------------
           FOOTER
        -------------------------------------------------------- */
        .footer-note {
            margin-top: 12px;
            font-size: 11px;
            opacity: 0.7;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header-top">
            <div class="title" id="titleText">Fahrten & Stunden</div>
            <div class="settings-wrapper">
                <button class="settings-btn" id="openSettings" type="button">‚öôÔ∏è</button>
                <span id="updateBadge" class="update-badge" style="display:none;"></span>
            </div>
        </div>

        <!-- SETTINGS POPUP -->
        <div class="settings-modal" id="settingsModal">
            <div class="settings-card">

                <!-- Close X -->
                <button class="settings-close-x" id="closeSettingsX" type="button">√ó</button>

                <h3>Einstellungen</h3>

                <!-- DARK MODE -->
                <div class="settings-group">
                    <span id="settingsDarkText">Dark Mode</span>
                    <button id="themeToggle" class="settings-toggle" type="button">üåô</button>
                </div>

                <!-- SPRACHE -->
                <div class="settings-group">
                    <span id="settingsLanguageText">Sprache</span>
                    <select id="languageSelect" class="settings-toggle" style="width:120px;">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>

                <!-- UPDATE-HINWEIS -->
                <div id="updateNotice"
                     style="display:none; margin-top:8px; font-size:12px;
                  padding:8px; border-radius:8px;
                  background:#fef3c7; color:#92400e; text-align:center;">
                </div>

                <!-- Button: App Update -->
                <button id="appUpdate" class="close-settings" type="button">
                    <span id="appUpdateText">App Update</span>
                </button>

                <!-- Button: Schlie√üen -->
                <button id="closeSettings" class="close-settings" type="button">
                    <span id="closeSettingsText">Fertig</span>
                </button>

                <!-- Version -->
                <div style="text-align:center; margin-top:10px; font-size:11px; opacity:0.6;">
                    Version 1.17
                </div>
            </div>
        </div>


        <!-- FORM F√úR NEUE FAHRT -->
        <label>
            <span id="labelPaymentText">Zahlungsart</span>
            <select id="zahlungsart">
                <option value="bar">Bar</option>
                <option value="online">Online-Bestellung</option>
            </select>
        </label>

        <label>
            <span id="labelAddressText">Adresse</span>
            <input type="text" id="adresse" list="addressSuggestions"
                   placeholder="bei Online nicht n√∂tig">
        </label>

        <!-- AUTOCOMPLETE LISTE -->
        <datalist id="addressSuggestions"></datalist>

        <label>
            <span id="labelBargeldText">Bargeldbetrag</span>
            <input type="number" id="bargeld" inputmode="decimal" placeholder="0">
        </label>

        <label>
            <span id="labelDistText">Distanz (km)</span>
            <input type="number" id="distanz" inputmode="decimal" placeholder="z. B. 6.4">
        </label>

        <label>
            <span id="labelManualExtraText">Zuschlag ab 8 km (manuell)</span>
            <input type="number" id="manualExtra" inputmode="decimal" placeholder="0">
        </label>

        <button class="btn-primary" id="addFahrtBtn" type="button">
            <span id="addFahrtText">Fahrt hinzuf√ºgen</span>
        </button>


        <!-- LISTE DER FAHRTEN -->
        <ul id="fahrtenListe"></ul>


        <!-- ZUSAMMENFASSUNG -->
        <div class="summary-box">
            <div class="summary-line">
                <span id="summaryHoursText">Stunden gearbeitet</span>
                <span class="summary-value" id="sumHours">0</span>
            </div>

            <label>
                <span id="labelHoursText">Stunden (x 7,50 ‚Ç¨)</span>
                <input type="number" id="stunden" inputmode="decimal" placeholder="0">
            </label>

            <div class="summary-line">
                <span id="summaryFahrtenText">Fahrten</span>
                <span class="summary-value" id="sumFahrten">0</span>
            </div>

            <div class="summary-line">
                <span id="summaryBonusText">Zuschl√§ge</span>
                <span class="summary-value" id="sumBonus">0,00 ‚Ç¨</span>
            </div>

            <div class="summary-line">
                <span id="summaryCashText">Erhaltenes Bargeld</span>
                <span class="summary-value" id="sumCash">0,00 ‚Ç¨</span>
            </div>

            <div class="summary-line">
                <span id="summaryToPayText">Noch auszuzahlen</span>
                <span class="summary-value" id="sumToPay">0,00 ‚Ç¨</span>
            </div>

            <button class="btn-primary" id="exportPdfBtn" type="button">
                <span id="exportPdfText">PDF exportieren</span>
            </button>
        </div>


        <!-- Footer -->
        <div class="footer-note" id="footerNoteText">
            Basis: 1,50 ‚Ç¨ pro Fahrt ¬∑ Zuschl√§ge: ab 5 km +0,50 ‚Ç¨, ab 7 km +1 ‚Ç¨, ab 7,5 km +1,50 ‚Ç¨, ab 8 km manuell
        </div>

        <div class="footer-note" style="margin-top:2px; font-size:10px; opacity:0.7;">
            Version 1.17
        </div>

    </div> <!-- /container -->
    <!-- SCRIPT START -->
    <script>
        /* ----------------------------------------------
           KONSTANTEN & VERSION
        ------------------------------------------------ */
        const APP_VERSION = "1.17";

        /* Liste f√ºr Autocomplete ‚Äì HIER deine Adressen eintragen */
        const KNOWN_ADDRESSES = [
            // Beispiel:
            // "Musterstra√üe 10, Laatzen",
            // "Hauptstra√üe 5, Laatzen",
        ];

        /* ----------------------------------------------
           DOM ELEMENTE
        ------------------------------------------------ */
        const settingsModal = document.getElementById('settingsModal');
        const openSettings = document.getElementById('openSettings');
        const closeSettingsBtn = document.getElementById('closeSettings');
        const closeSettingsX = document.getElementById('closeSettingsX');
        const themeToggle = document.getElementById('themeToggle');
        const languageSelect = document.getElementById('languageSelect');
        const appUpdateBtn = document.getElementById('appUpdate');
        const updateBadge = document.getElementById('updateBadge');

        const zahlungsartSelect = document.getElementById('zahlungsart');
        const adresseInput = document.getElementById('adresse');
        const bargeldInput = document.getElementById('bargeld');
        const distanzInput = document.getElementById('distanz');
        const manualExtraInput = document.getElementById('manualExtra');
        const addFahrtBtn = document.getElementById('addFahrtBtn');

        const fahrtenListe = document.getElementById('fahrtenListe');

        const stundenInput = document.getElementById('stunden');
        const sumHours = document.getElementById('sumHours');
        const sumFahrten = document.getElementById('sumFahrten');
        const sumBonus = document.getElementById('sumBonus');
        const sumCash = document.getElementById('sumCash');
        const sumToPay = document.getElementById('sumToPay');

        /* ----------------------------------------------------------
           SPRACHEN (UI-Texte)
        ---------------------------------------------------------- */
        const translations = {
            de: {
                title: "Fahrten & Stunden",
                payment: "Zahlungsart",
                address: "Adresse",
                bargeld: "Bargeldbetrag",
                distanz: "Distanz (km)",
                manualExtra: "Zuschlag ab 8 km (manuell)",
                addFahrt: "Fahrt hinzuf√ºgen",
                darkMode: "Dark Mode",
                language: "Sprache",
                appUpdate: "App Update",
                fertig: "Fertig",
                hoursWorked: "Stunden gearbeitet",
                hoursLabel: "Stunden (x 7,50 ‚Ç¨)",
                fahrten: "Fahrten",
                bonus: "Zuschl√§ge",
                cash: "Erhaltenes Bargeld",
                toPay: "Noch auszuzahlen",
                exportPdf: "PDF exportieren",
            },
            en: {
                title: "Rides & Hours",
                payment: "Payment type",
                address: "Address",
                bargeld: "Cash amount",
                distanz: "Distance (km)",
                manualExtra: "Extra charge above 8 km (manual)",
                addFahrt: "Add Ride",
                darkMode: "Dark Mode",
                language: "Language",
                appUpdate: "App Update",
                fertig: "Done",
                hoursWorked: "Hours worked",
                hoursLabel: "Hours (x ‚Ç¨7.50)",
                fahrten: "Rides",
                bonus: "Surcharges",
                cash: "Cash received",
                toPay: "To be paid",
                exportPdf: "Export PDF",
            },
            ru: {
                title: "–ü–æ–µ–∑–¥–∫–∏ –∏ —á–∞—Å—ã",
                payment: "–¢–∏–ø –æ–ø–ª–∞—Ç—ã",
                address: "–ê–¥—Ä–µ—Å",
                bargeld: "–°—É–º–º–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏",
                distanz: "–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)",
                manualExtra: "–î–æ–ø–ª–∞—Ç–∞ –æ—Ç 8 –∫–º (–≤—Ä—É—á–Ω—É—é)",
                addFahrt: "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–µ–∑–¥–∫—É",
                darkMode: "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞",
                language: "–Ø–∑—ã–∫",
                appUpdate: "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
                fertig: "–ì–æ—Ç–æ–≤–æ",
                hoursWorked: "–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã",
                hoursLabel: "–ß–∞—Å—ã (x ‚Ç¨7.50)",
                fahrten: "–ü–æ–µ–∑–¥–∫–∏",
                bonus: "–î–æ–ø–ª–∞—Ç—ã",
                cash: "–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–ª–∏—á–Ω—ã–µ",
                toPay: "–ö –≤—ã–ø–ª–∞—Ç–µ",
                exportPdf: "–≠–∫—Å–ø–æ—Ä—Ç PDF",
            }
        };

        /* ----------------------------------------------------------
           SPRACHEN INITIALISIEREN
        ---------------------------------------------------------- */
        function initLanguage() {
            const lang = localStorage.getItem("language") || "de";
            languageSelect.value = lang;
            applyLanguage(lang);
        }

        function applyLanguage(lang) {
            const t = translations[lang];

            document.getElementById("titleText").textContent = t.title;
            document.getElementById("labelPaymentText").textContent = t.payment;
            document.getElementById("labelAddressText").textContent = t.address;
            document.getElementById("labelBargeldText").textContent = t.bargeld;
            document.getElementById("labelDistText").textContent = t.distanz;
            document.getElementById("labelManualExtraText").textContent = t.manualExtra;
            document.getElementById("addFahrtText").textContent = t.addFahrt;

            document.getElementById("settingsDarkText").textContent = t.darkMode;
            document.getElementById("settingsLanguageText").textContent = t.language;
            document.getElementById("appUpdateText").textContent = t.appUpdate;
            document.getElementById("closeSettingsText").textContent = t.fertig;

            document.getElementById("summaryHoursText").textContent = t.hoursWorked;
            document.getElementById("labelHoursText").textContent = t.hoursLabel;
            document.getElementById("summaryFahrtenText").textContent = t.fahrten;
            document.getElementById("summaryBonusText").textContent = t.bonus;
            document.getElementById("summaryCashText").textContent = t.cash;
            document.getElementById("summaryToPayText").textContent = t.toPay;
            document.getElementById("exportPdfText").textContent = t.exportPdf;

            localStorage.setItem("language", lang);
        }

        /* Dropdown Sprache √§ndern */
        languageSelect.addEventListener("change", () => {
            const lang = languageSelect.value;
            applyLanguage(lang);
        });

        /* ----------------------------------------------------------
           DARK MODE
        ---------------------------------------------------------- */
        function initTheme() {
            const theme = localStorage.getItem("theme") || "light";
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
                themeToggle.textContent = "‚òÄÔ∏è";
            } else {
                document.documentElement.classList.remove("dark");
                themeToggle.textContent = "üåô";
            }
        }

        themeToggle.addEventListener("click", () => {
            const isDark = document.documentElement.classList.toggle("dark");
            themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        });

        /* ----------------------------------------------------------
           SETTINGS POPUP HANDLING
        ---------------------------------------------------------- */
        openSettings.addEventListener("click", () => settingsModal.style.display = "flex");
        closeSettingsBtn.addEventListener("click", () => settingsModal.style.display = "none");
        closeSettingsX.addEventListener("click", () => settingsModal.style.display = "none");
        settingsModal.addEventListener("click", (e) => {
            if (e.target === settingsModal) settingsModal.style.display = "none";
        });

        /* ----------------------------------------------------------
           AUTOCOMPLETE (DATALIST)
        ---------------------------------------------------------- */
        function fillAddressDatalist() {
            const dl = document.getElementById("addressSuggestions");
            dl.innerHTML = "";
            KNOWN_ADDRESSES.forEach(addr => {
                const opt = document.createElement("option");
                opt.value = addr;
                dl.appendChild(opt);
            });
        }
        fillAddressDatalist();

        /* ----------------------------------------------------------
           FAHRTEN
        ---------------------------------------------------------- */
        let fahrten = [];

        function saveState() {
            localStorage.setItem("fahrten", JSON.stringify(fahrten));
            localStorage.setItem("stunden", stundenInput.value || "0");
        }

        function loadState() {
            fahrten = JSON.parse(localStorage.getItem("fahrten") || "[]");
            stundenInput.value = localStorage.getItem("stunden") || "0";
        }

        /* Fahrten rendern */
        function renderFahrten() {
            fahrtenListe.innerHTML = "";

            if (fahrten.length === 0) {
                fahrtenListe.innerHTML = `<li class="fahrt-item">Keine Fahrten erfasst.</li>`;
                return;
            }

            fahrten.forEach((f, index) => {
                const li = document.createElement("li");
                li.className = "fahrt-item";

                const header = document.createElement("div");
                header.className = "fahrt-header";

                const addr = document.createElement("div");
                addr.className = "fahrt-adresse";
                addr.textContent = f.adresse;

                const right = document.createElement("div");
                right.className = "fahrt-verg";

                if (f.zahlungsart === "bar") right.textContent = `${f.bargeld.toFixed(2)} ‚Ç¨`;
                else right.textContent = "Online";

                header.appendChild(addr);
                header.appendChild(right);

                const meta = document.createElement("div");
                meta.className = "fahrt-meta";

                const left = document.createElement("div");
                left.className = "fahrt-meta-left";

                const pillPay = document.createElement("span");
                pillPay.className = `pill ${f.zahlungsart === "bar" ? "pill-bar" : "pill-online"}`;
                pillPay.textContent = f.zahlungsart === "bar" ? "Bar" : "Online";
                left.appendChild(pillPay);

                const pillDist = document.createElement("span");
                pillDist.className = "pill pill-distance";
                pillDist.textContent = f.dist > 0 ? `${f.dist.toFixed(1)} km` : "< 5 km";
                left.appendChild(pillDist);

                const fahrtSum = document.createElement("span");
                fahrtSum.textContent = `¬∑ Fahrt: ${f.verg√ºtung.toFixed(2)} ‚Ç¨`;
                left.appendChild(fahrtSum);

                /* Buttons */
                const rightBtns = document.createElement("div");
                rightBtns.className = "fahrt-meta-right";

                const delBtn = document.createElement("button");
                delBtn.className = "btn-small delete";
                delBtn.textContent = "L√∂schen";
                delBtn.onclick = () => {
                    fahrten.splice(index, 1);
                    saveState();
                    renderFahrten();
                    berechneZusammenfassung();
                };

                rightBtns.appendChild(delBtn);

                meta.appendChild(left);
                meta.appendChild(rightBtns);

                li.appendChild(header);
                li.appendChild(meta);
                fahrtenListe.appendChild(li);
            });
        }

        /* Fahrt hinzuf√ºgen */
        addFahrtBtn.addEventListener("click", () => {
            const zahl = zahlungsartSelect.value;
            const adr = adresseInput.value.trim();
            const barg = parseFloat(bargeldInput.value) || 0;
            let dist = parseFloat(distanzInput.value) || 0;
            let extraManual = parseFloat(manualExtraInput.value) || 0;

            if (zahl === "online") {
                dist = dist; // optional
            }

            let extraBonus = 0;

            if (dist >= 8) extraBonus = extraManual;
            else if (dist >= 7.5) extraBonus = 1.5;
            else if (dist >= 7) extraBonus = 1.0;
            else if (dist >= 5) extraBonus = 0.5;

            const verg = 1.5 + extraBonus;

            fahrten.push({
                zahlungsart: zahl,
                adresse: zahl === "online" ? "Online-Bestellung" : adr,
                bargeld: zahl === "bar" ? barg : 0,
                dist: dist,
                extraBonus: extraBonus,
                verg√ºtung: verg
            });

            saveState();
            renderFahrten();
            berechneZusammenfassung();

            adresseInput.value = "";
            bargeldInput.value = "";
            distanzInput.value = "";
            manualExtraInput.value = "";
        });
        /* ----------------------------------------------------------
           ZUSAMMENFASSUNG BERECHNEN
        ---------------------------------------------------------- */
        function berechneZusammenfassung() {
            const stunden = parseFloat(stundenInput.value) || 0;
            const stundenlohn = stunden * 7.5;

            const sumF = fahrten.length;
            const sumBargeld = fahrten.reduce((s, f) => s + f.bargeld, 0);
            const sumVerg = fahrten.reduce((s, f) => s + f.verg√ºtung, 0);
            const sumExtra = fahrten.reduce((s, f) => s + f.extraBonus, 0);

            const netto = stundenlohn + sumVerg - sumBargeld;

            sumHours.textContent = `${stunden}`;
            sumFahrten.textContent = `${sumF}`;
            sumBonus.textContent = `${sumExtra.toFixed(2)} ‚Ç¨`;
            sumCash.textContent = `${sumBargeld.toFixed(2)} ‚Ç¨`;

            sumToPay.textContent = `${netto.toFixed(2)} ‚Ç¨`;
            sumToPay.classList.remove("summary-green", "summary-red");
            if (netto >= 0) sumToPay.classList.add("summary-green");
            else sumToPay.classList.add("summary-red");

            saveState();
        }

        stundenInput.addEventListener("input", berechneZusammenfassung);


        /* ----------------------------------------------------------
           PDF EXPORT (IMMER DEUTSCH)
        ---------------------------------------------------------- */
        document.getElementById("exportPdfBtn").addEventListener("click", exportToPdf);

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text("Fahrten & Stunden ‚Äì Abrechnung", 14, 18);

            doc.setFontSize(12);
            doc.text(`Datum: ${new Date().toLocaleDateString("de-DE")}`, 14, 28);

            /* Tabelle Kopf */
            let y = 40;
            doc.setFontSize(11);
            doc.text("Adresse / Art", 14, y);
            doc.text("km", 90, y);
            doc.text("Bargeld", 120, y);
            doc.text("Fahrt ‚Ç¨", 160, y);

            doc.setLineWidth(0.3);
            doc.line(14, y + 2, 196, y + 2);
            y += 8;

            /* Inhalte */
            fahrten.forEach(f => {
                if (y >= 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(f.adresse, 14, y);

                doc.text(f.dist > 0 ? f.dist.toFixed(1) : "<5", 90, y);
                doc.text(f.bargeld > 0 ? `${f.bargeld.toFixed(2)} ‚Ç¨` : "-", 120, y);
                doc.text(`${f.verg√ºtung.toFixed(2)} ‚Ç¨`, 160, y);

                y += 8;
            });

            /* Summary */
            y += 6;
            doc.line(14, y, 196, y);
            y += 10;

            const stunden = parseFloat(stundenInput.value) || 0;
            const stundenlohn = stunden * 7.5;
            const sumBargeld = fahrten.reduce((s, f) => s + f.bargeld, 0);
            const sumVerg = fahrten.reduce((s, f) => s + f.verg√ºtung, 0);
            const netto = stundenlohn + sumVerg - sumBargeld;

            doc.setFontSize(12);
            doc.text(`Stunden (${stunden} √ó 7,50 ‚Ç¨): ${stundenlohn.toFixed(2)} ‚Ç¨`, 14, y); y += 6;
            doc.text(`Fahrtenverg√ºtung: ${sumVerg.toFixed(2)} ‚Ç¨`, 14, y); y += 6;
            doc.text(`Erhaltenes Bargeld: ${sumBargeld.toFixed(2)} ‚Ç¨`, 14, y); y += 6;

            doc.setFontSize(13);
            doc.text(`Noch auszuzahlen: ${netto.toFixed(2)} ‚Ç¨`, 14, y);

            doc.save("abrechnung.pdf");
        }


        /* ----------------------------------------------------------
           UPDATE-HINWEIS + BADGE
        ---------------------------------------------------------- */
        function showUpdateNotification(newVersion) {
            const box = document.getElementById("updateNotice");
            box.innerHTML = `
        Neue Version verf√ºgbar: ${newVersion}<br>
        <button id="updateNowBtn"
                style="margin-top:6px; padding:4px 10px; border-radius:8px;
                       border:none; background:#2563eb; color:white; cursor:pointer;">
          Jetzt aktualisieren
        </button>
      `;
            box.style.display = "block";

            // üî¥ Badge neben Zahnrad anzeigen
            const badge = document.getElementById("updateBadge");
            if (badge) {
                badge.style.display = "inline-flex";
            }

            document.getElementById("updateNowBtn").onclick = () => {
                location.reload(true);
            };
        }


        /* ----------------------------------------------------------
           VERSION CHECK VON GITHUB
        ---------------------------------------------------------- */
        async function checkForUpdate() {
            try {
                const url = "https://imannsv.github.io/fahrtenapp/version.json";

                const response = await fetch(url, { cache: "no-store" });
                const data = await response.json();
                const remoteVersion = data.version;

                if (remoteVersion !== APP_VERSION) {
                    showUpdateNotification(remoteVersion);
                }
            } catch (e) {
                console.warn("Update-Check fehlgeschlagen:", e);
            }
        }


        /* ----------------------------------------------------------
           APP UPDATE BUTTON
        ---------------------------------------------------------- */
        appUpdateBtn.addEventListener("click", () => {
            location.reload(true);
        });


        /* ----------------------------------------------------------
           INITIALISIERUNG
        ---------------------------------------------------------- */
        function init() {
            initTheme();
            initLanguage();
            loadState();
            renderFahrten();
            berechneZusammenfassung();
            checkForUpdate();
        }

        init();

    </script>

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
